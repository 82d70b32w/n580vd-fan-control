#!/bin/sh

#-------------------------------------------------------------------------------
# Copyright 2017-2018 Dominik Salvet
# SPDX-License-Identifier: MIT
# https://gitlab.com/dominiksalvet/ux430ua-fan-speed
#-------------------------------------------------------------------------------


#-------------------------------------------------------------------------------
# SOFTWARE DEPENDENCIES
#-------------------------------------------------------------------------------

# list of required software
SW_REQUIRED='echo [ cat printf grep'

# check if some software is missing
for i in $SW_REQUIRED; do
    # software is missing if at least one piece of software is missing
    if ! command -v "$i" > /dev/null; then
        echo "$0: Required software '$i' is missing, installation canceled." >&2
        exit 1
    fi
done

#-------------------------------------------------------------------------------
# DEFINITIONS
#-------------------------------------------------------------------------------

# the current version of the program
VERSION='1.0.0'

HELP_MESSAGE="Usage: $0 [OPTION]...

OPTION:
  -help     display this help and exit
  -about    display information and exit
  -version  display version and exit"

ABOUT_MESSAGE="ux430ua-fan-speed $VERSION
Set up fan speed policy of ASUS ZenBook UX430UA to make it more quiet on Linux.

Copyright 2017-2018 Dominik Salvet
SPDX-License-Identifier: MIT
https://gitlab.com/dominiksalvet/ux430ua-fan-speed"

HINT_MESSAGE="Try '$0 -help' for more information."

#-------------------------------------------------------------------------------
# PROCESSING PARAMETERS
#-------------------------------------------------------------------------------

# processing each parameter separately
for i in "$@"; do
    case "$i" in
        -help)
            echo "$HELP_MESSAGE"
            exit 0
            ;;
        -about)
            echo "$ABOUT_MESSAGE"
            exit 0
            ;;
        -version)
            echo "$VERSION"
            exit 0
            ;;
        *)
            echo "$0: The option '$i' was not recognized." >&2
            echo "$HINT_MESSAGE" >&2
            exit 1
            ;;
    esac
done

#-------------------------------------------------------------------------------
# DEFINITIONS
#-------------------------------------------------------------------------------

# base address for fan speed configuration
FAN_SPEED_BASE_ADDR=1335

# array of temperatures (in Celsius) per each fan speed level
FAN_TEMPS='55 60 62 65 68 72 76 80'

# TODO: uncomment redirecting to file
# direct ACPI call
acpi_call() {
    # $1 would work in this case, but the following solution is safer due to possible reuse
    echo "$*" > /proc/acpi/call
    cat /proc/acpi/call
    echo
}

# convert number from decimal to hexadecimal form
dec_to_hex() {
    printf '%X' "$1"
}

# get address of each fan speed level
level_to_addr() {
    echo $((FAN_SPEED_BASE_ADDR + $1))
}

# assigning fan speed level and temperature
level_temp_set() {
    acpi_call '\_SB.PCI0.LPCB.EC0.WRAM '"0x$(dec_to_hex "$(level_to_addr "$1")") 0x$(dec_to_hex "$2")"
}

#-------------------------------------------------------------------------------
# EXECUTION
#-------------------------------------------------------------------------------

# check "FAN_TEMPS" length
if ! echo "$FAN_TEMPS" | grep -q -E -e '^([1-9][0-9]* ){7}[1-9][0-9]*$'; then
    echo "$0: Length of the \"FAN_TEMPS\" array must be exactly 8, configuration canceled." >&2
    exit 1
fi

# setup each individual fan speed level
i=0
for temp in $FAN_TEMPS; do
    level_temp_set "$i" "$temp"
    i=$((i + 1))
done
