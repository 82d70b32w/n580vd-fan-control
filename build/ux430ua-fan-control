#!/bin/sh

#-------------------------------------------------------------------------------
# Copyright 2017-2018 Dominik Salvet
# SPDX-License-Identifier: MIT
# https://gitlab.com/dominiksalvet/ux430ua-fan-control
#-------------------------------------------------------------------------------


#-------------------------------------------------------------------------------
# SOFTWARE DEPENDENCIES
#-------------------------------------------------------------------------------

# list of required software
SW_REQUIRED='echo [ cat grep lsmod'

# check if some software is missing
for i in $SW_REQUIRED; do
    # software is missing if at least one piece of software is missing
    if ! command -v "$i" > /dev/null; then
        echo "$0: Required software '$i' is missing, action canceled." >&2
        exit 1
    fi
done

# check if 'acpi_call' module loaded
if ! lsmod | grep -q -E -e '^[[:blank:]]*acpi_call[[:blank:]].*$'; then
    echo "$0: Required module 'acpi_call' is not loaded, action canceled.
POSSIBLE SOLUTIONS:
  * install program dependencies
  * reboot your device" >&2
    exit 1
fi

# check if interface file for 'acpi_call' module exists
if [ -f /proc/acpi/call ]; then
    echo "$0: Interface file '/proc/acpi/call' for 'acpi_call' module doesn't exist, action canceled.
POSSIBLE SOLUTIONS:
  * install program dependencies
  * reboot your device" >&2
    exit 1
fi

#-------------------------------------------------------------------------------
# PROGRAM OUTPUT INFORMATION
#-------------------------------------------------------------------------------

# the current version of the program
VERSION='1.0.0'

HELP_MESSAGE="Usage: $0 [OPTION]...

OPTION:
  -help     display this help and exit
  -about    display information and exit
  -version  display version and exit"

ABOUT_MESSAGE="ux430ua-fan-control $VERSION
Set up fan speed policy of ASUS ZenBook UX430UA to make it more quiet on Linux.

Copyright 2017-2018 Dominik Salvet
SPDX-License-Identifier: MIT
https://gitlab.com/dominiksalvet/ux430ua-fan-control"

HINT_MESSAGE="Try '$0 -help' for more information."

#-------------------------------------------------------------------------------
# PROCESSING PARAMETERS
#-------------------------------------------------------------------------------

# processing each parameter separately
for i in "$@"; do
    case "$i" in
        -help)
            echo "$HELP_MESSAGE"
            exit 0
            ;;
        -about)
            echo "$ABOUT_MESSAGE"
            exit 0
            ;;
        -version)
            echo "$VERSION"
            exit 0
            ;;
        *)
            echo "$0: The option '$i' was not recognized." >&2
            echo "$HINT_MESSAGE" >&2
            exit 1
            ;;
    esac
done

#-------------------------------------------------------------------------------
# DEFINITIONS
#-------------------------------------------------------------------------------

# list of ascending values of temperatures (in degrees Celsius) per each fan speed level
FAN_TEMPS='55 60 62 65 68 72 76 80'

# the base address for fan speed levels configuration
CONFIG_BASE_ADDR=1335

# DESCRIPTION:
#   Set temperature boundary to a chosen fan speed level.
# PARAMETERS:
#   $1 - fan speed level (0-7)
#   $2 - temperature in degrees Celsius
set_temp_boundary() {
    # direct ACPI call
    echo '\_SB.PCI0.LPCB.EC0.WRAM '"$((CONFIG_BASE_ADDR + $1)) $2" > /proc/acpi/call
    cat /proc/acpi/call
    # previous command misses a new line character, so echo new line
    echo
}

#-------------------------------------------------------------------------------
# APPLY CONFIGURATION
#-------------------------------------------------------------------------------

# check if running as root
if [ "$(id -u)" -ne 0 ]; then
    echo "$0: Please run as root, action canceled." >&2
    exit 1
fi

# check values of temperature boundaries
temp_counter=0
previous_temp=0
for temp in $FAN_TEMPS; do
    # check if parameter is a number and has greater value than the previous one
    if ! echo "$temp" | grep -q -E -e '^[1-9][0-9]?$' || [ "$temp" -le "$previous_temp" ]; then
        # indicate this error
        previous_temp=0
        break
    fi
    temp_counter="$((temp_counter + 1))"
    previous_temp="$temp"
done

# check if an error indicated or there is not exactly 8 temperature values
if [ "$previous_temp" -eq 0 ] || [ "$temp_counter" -ne 8 ]; then
    echo "$0: Values of temperature boundaries are invalid, action canceled." >&2
    exit 1
fi

# set up each individual fan speed level
i=0
for temp in $FAN_TEMPS; do
    set_temp_boundary "$i" "$temp"
    i="$((i + 1))"
done
